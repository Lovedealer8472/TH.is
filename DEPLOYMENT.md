# Deployment Guide - Tölvuhvíslarinn

Quick deployment guide to get your site online on your Linux server.

## Prerequisites

- Linux server with SSH access
- Node.js 18+ installed
- Domain name pointed to your server (tolvuhvislarinn.is)

## Quick Deployment Steps

### 1. Upload Your Code

Upload all files to your server (except `node_modules` and `.next`):

```bash
# On your local machine, compress the project
# Upload via SCP, SFTP, or Git

# Or use Git (recommended):
git init
git add .
git commit -m "Initial commit"
# Add remote and push, then on server:
# git clone <your-repo-url>
```

### 2. On Your Server

```bash
# Navigate to your project directory
cd /path/to/tolvuhvislarinn

# Install dependencies
npm install --production

# Create .env.local file with your production settings
nano .env.local
```

### 3. Environment Variables (.env.local)

Add these to `.env.local` on your server:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password-here
SMTP_FROM=your-email@gmail.com
CONTACT_EMAIL=tolvuhvislarinn@gmail.com
```

**Important:** 
- Replace `your-email@gmail.com` with your actual Gmail address
- Replace `your-app-password-here` with your Gmail App Password (not your regular password)
- See `README_EMAIL_SETUP.md` for detailed instructions on generating an App Password

### 4. Build and Run

```bash
# Build for production
npm run build

# Run the server
npm start
```

The site will run on port 3000 by default.

### 5. Run as a Service (PM2 - Recommended)

```bash
# Install PM2 globally
npm install -g pm2

# Start the app
pm2 start npm --name "tolvuhvislarinn" -- start

# Save PM2 configuration
pm2 save

# Set up PM2 to start on boot
pm2 startup
# (Follow the instructions it provides)

# Useful PM2 commands:
pm2 status          # Check status
pm2 logs            # View logs
pm2 restart tolvuhvislarinn  # Restart
pm2 stop tolvuhvislarinn     # Stop
```

### 6. Reverse Proxy (Nginx)

If you want to serve on port 80/443, set up Nginx as reverse proxy:

```bash
# Install Nginx
sudo apt update
sudo apt install nginx

# Create Nginx config
sudo nano /etc/nginx/sites-available/tolvuhvislarinn
```

Add this configuration:

```nginx
server {
    listen 80;
    server_name tolvuhvislarinn.is www.tolvuhvislarinn.is;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable and start:

```bash
sudo ln -s /etc/nginx/sites-available/tolvuhvislarinn /etc/nginx/sites-enabled/
sudo nginx -t  # Test configuration
sudo systemctl restart nginx
```

### 7. SSL Certificate (Let's Encrypt)

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d tolvuhvislarinn.is -d www.tolvuhvislarinn.is

# Auto-renewal is set up automatically
```

## Quick Commands Summary

```bash
# On server - first time setup
npm install --production
# (Create .env.local)
npm run build
pm2 start npm --name "tolvuhvislarinn" -- start
pm2 save
pm2 startup

# Updates (after pushing new code)
git pull
npm install --production
npm run build
pm2 restart tolvuhvislarinn
```

## Port Configuration

- Default: Port 3000
- To change port: `PORT=3001 npm start` or set in PM2 ecosystem file
- Nginx will proxy port 80/443 to your Node.js port

## Troubleshooting

- **Can't connect**: Check firewall (allow port 3000, 80, 443)
- **Email not working**: Verify `.env.local` has correct SMTP credentials
- **App crashes**: Check logs with `pm2 logs tolvuhvislarinn`
- **Port already in use**: Change port or kill existing process

## File Structure on Server

```
/var/www/tolvuhvislarinn/  (or your chosen path)
├── .env.local             (keep secure, don't commit)
├── package.json
├── next.config.js
├── app/
├── components/
├── lib/
├── public/
└── .next/                 (generated by build)
```

## Security Notes

- Keep `.env.local` secure (chmod 600)
- Don't commit `.env.local` to Git
- Keep Node.js and dependencies updated
- Use strong passwords for server access
- Enable firewall (UFW recommended)

## Need Help?

- Check PM2 logs: `pm2 logs tolvuhvislarinn`
- Check Nginx logs: `sudo tail -f /var/log/nginx/error.log`
- Check system logs: `journalctl -u nginx`
